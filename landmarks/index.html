<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8" />
        <meta window="viewport" content="initial-scale=1.0">
        <title>Landmarks</title>
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
        <link rel="stylesheet" href="landmarks_styles.css" />

        <script>
            var lat = 0, lng = 0;
            var login = "WALLACE_HEATH";
            var data = null, info = null, map = null, marker_array = null;
            var user_image = {
                    url: "images/user_icon.png",
                    scaledSize: new google.maps.Size(64, 72),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(32, 72)
            };
            var person_image = {
                    url: "images/person_icon.png",
                    scaledSize: new google.maps.Size(36, 72),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(18, 72)
            };
            var landmark_image = {
                    url: "images/landmark_icon.png",
                    scaledSize: new google.maps.Size(36, 72),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(18, 72)
            };

            getLocation();

            function getLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        lat = position.coords.latitude;
                        lng = position.coords.longitude;
                        console.log(lat);
                        console.log(lng);
                        initialize_map();
                    });
                } else {
                    alert("Geolocation is not supported by your web browser");
                }
            }

            function initialize_map() {

                var my_position = new google.maps.LatLng(lat, lng);
                console.log(my_position);

                map = new google.maps.Map(document.getElementById("map"),
                            {center: my_position, zoom: 15});
                var marker = new google.maps.Marker({
                    position: my_position,
                    animation: google.maps.Animation.DROP,
                    map: map,
                    icon: user_image,
                    title: "Here I am!"
                });
                console.log(marker);

                marker.addListener("click", function() {
                    return showInfo(marker);
                });

                getLandmarks();
            }

            function getLandmarks() {
                var source = "https://defense-in-derpth.herokuapp.com/sendLocation";

                var post = "login=" + login + "&lat=" + lat + "&lng=" + lng;
                console.log(post);

                var request = new XMLHttpRequest();
                request.open("POST", source, true);
                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                request.onreadystatechange = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        var raw = request.responseText;
                        data = JSON.parse(raw);
                        console.log(data);
                        displayLandmarks();
                    }
                };

                request.send(post);
            }

            function displayLandmarks() {
                marker_array = new Array(data.landmarks.length);
                for (i = 0; i < data.landmarks.length; i++) {
                    marker_array[i] = new google.maps.Marker({
                        position: new google.maps.LatLng(
                            data.landmarks[i].geometry.coordinates[1],
                            data.landmarks[i].geometry.coordinates[0]
                        ),
                        animation: google.maps.Animation.DROP,
                        icon: landmark_image,
                        map: map,
                        title: "Landmark"
                    });
                    marker_array[i].addListener("click", function() {
                        return showInfo(this);
                    });
                    console.log(data.landmarks[i].geometry.coordinates);
                }
                console.log(marker_array);
            }

            function showInfo(curr_marker) {
                if (info != null) {
                    info.close();
                }
                info = new google.maps.InfoWindow({content: curr_marker.title});
                info.open(map, curr_marker);
            }

        </script>

    </head>

    <body onload="initialize_map()">
        <div id="map"></div>
    </body>


</html>