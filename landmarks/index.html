<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8" />
        <meta window="viewport" content="initial-scale=1.0">
        <title>Landmarks</title>
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
        <link rel="stylesheet" href="landmarks_styles.css" />

        <script>
            var lat = 0, lng = 0;
            var login = "WALLACE_HEATH";
            var data = null, info = null, map = null;
            var person_array = null, landmark_array = null;
            var people_shown = true, landmarks_shown = true;
            var user_image = {
                    url: "images/user_icon.png",
                    scaledSize: new google.maps.Size(64, 72),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(32, 72)
            };
            var person_image = {
                    url: "images/person_icon.png",
                    scaledSize: new google.maps.Size(36, 72),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(18, 72)
            };
            var landmark_image = {
                    url: "images/landmark_icon.png",
                    scaledSize: new google.maps.Size(36, 72),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(18, 72)
            };

            getLocation();

            function getLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        lat = position.coords.latitude;
                        lng = position.coords.longitude;
                        console.log(lat);
                        console.log(lng);
                        initializeMap();
                    });
                } else {
                    alert("Geolocation is not supported by your web browser");
                }
            }

            function initializeMap() {

                var my_position = new google.maps.LatLng(lat, lng);
                console.log(my_position);

                map = new google.maps.Map(document.getElementById("map"),
                            {center: my_position, zoom: 15});
                var marker = new google.maps.Marker({
                    position: my_position,
                    animation: google.maps.Animation.DROP,
                    map: map,
                    icon: user_image,
                    title: "Here I am!"
                });
                console.log(marker);

                marker.addListener("click", function() {
                    return showInfo(marker);
                });

                getLandmarks();
            }

            function getLandmarks() {
                var source = "https://defense-in-derpth.herokuapp.com/sendLocation";

                var post = "login=" + login + "&lat=" + lat + "&lng=" + lng;
                console.log(post);

                var request = new XMLHttpRequest();
                request.open("POST", source, true);
                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                request.onreadystatechange = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        var raw = request.responseText;
                        data = JSON.parse(raw);
                        console.log(data);
                        initializeLandmarks();
                        initializePeople();
                    }
                };

                request.send(post);
            }

            function initializeLandmarks() {
                landmark_array = new Array(data.landmarks.length);
                for (i = 0; i < data.landmarks.length; i++) {
                    landmark_array[i] = new google.maps.Marker({
                        position: new google.maps.LatLng(
                            data.landmarks[i].geometry.coordinates[1],
                            data.landmarks[i].geometry.coordinates[0]
                        ),
                        animation: google.maps.Animation.DROP,
                        icon: landmark_image,
                        map: map,
                        title: data.landmarks[i].properties.Details
                    });
                    landmark_array[i].addListener("click", function() {
                        return showInfo(this);
                    });
                    console.log(data.landmarks[i].geometry.coordinates);
                }
                console.log(landmark_array);
            }

            function initializePeople() {
                people_array = new Array(data.people.length);
                for (i = 0; i < data.people.length; i++) {
                    people_array[i] = new google.maps.Marker({
                        position: new google.maps.LatLng(
                            data.people[i].lat, data.people[i].lng),
                        animation: google.maps.Animation.DROP,
                        icon: person_image,
                        map: map,
                        title: data.people[i].login
                    });
                    people_array[i].addListener("click", function() {
                        return showInfo(this);
                    });
                    if (people_array[i].title == login) {
                        people_array[i].setMap(null);
                    }
                }
            }

            function showInfo(curr_marker) {
                if (info != null) {
                    info.close();
                }
                info = new google.maps.InfoWindow({content: curr_marker.title});
                info.open(map, curr_marker);
            }

            function togglePeople() {
                for (i = 0; i < people_array.length; i++) {
                    if (people_shown) {
                        people_array[i].setMap(null);
                    } else if (people_array[i].title != login) {
                        people_array[i].setMap(map);
                    }
                }
                people_shown = !people_shown;
            }

            function toggleLandmarks() {
                for (i = 0; i < landmark_array.length; i++) {
                    if (landmarks_shown) {
                        landmark_array[i].setMap(null);
                    } else {
                        landmark_array[i].setMap(map);
                    }
                }
                landmarks_shown = !landmarks_shown;
            }

        </script>

    </head>

    <body onload="initializeMap()">
        <div id="buttons">
            <button class="button" onclick=togglePeople()>People</button>
            <button class="button" onclick=toggleLandmarks()>Landmarks</button>
        </div>
        <div id="map"></div>
    </body>


</html>